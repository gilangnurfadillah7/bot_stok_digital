diff --git a/src/controllers/telegram.controller.ts.original b/src/controllers/telegram.controller.ts
index 3c46e9a..77f13ed 100644
--- a/src/controllers/telegram.controller.ts.original
+++ b/src/controllers/telegram.controller.ts
@@ -6,8 +6,9 @@ import { gasClient } from '../clients/gas.client';
 import { sheetsService } from '../services/sheets.service';
 import { decodeCallbackData, encodeCallbackData } from '../utils/callback';
 import { telegramClient, InlineKeyboardMarkup } from '../utils/telegram';
-import { PendingInput, Product } from '../types';
+import { PendingInput, Product, AccountResult, TelegramUpdate as TUpdate } from '../types';
 
+// Re-declare types locally for clarity and to avoid circular dependency issues with the harness
 type TelegramUser = {
   id: number;
   username?: string;
@@ -29,10 +30,8 @@ type CallbackQuery = {
   message?: TelegramMessage;
 };
 
-type TelegramUpdate = {
-  message?: TelegramMessage;
-  callback_query?: CallbackQuery;
-};
+// Use the imported type for the controller's public interface
+type TelegramUpdate = TUpdate;
 
 const pendingInputs = new Map<number, PendingInput>();
 const restockBuffers = new Map<number, { product: Product; lines: string[] }>();
@@ -72,6 +71,18 @@ const sendHome = async (chatId: number, isOwner: boolean) =>
     reply_markup: homeKeyboard(isOwner),
   });
 
+// --------- UTIL ---------
+const listRecentActiveOrders = async (limit = 10) => sheetsService.listRecentActiveOrders(limit);
+
+const editMessageReplyMarkup = async (chatId: number, messageId: number, reply_markup: InlineKeyboardMarkup) => {
+  try {
+    await telegramClient.editMessageReplyMarkup(chatId, messageId, reply_markup);
+  } catch (e) {
+    // Ignore error if message is too old or already edited
+    console.warn(`Failed to edit message ${messageId} in chat ${chatId}: ${e}`);
+  }
+};
+
 // --------- ORDER FLOW ----------
 const sendOrderChannel = async (chatId: number) => {
   const keyboard: InlineKeyboardMarkup = {
@@ -166,14 +177,18 @@ const sendReportMenu = async (chatId: number) => {
   await telegramClient.sendMessage(chatId, 'Pilih laporan', { reply_markup: keyboard });
 };
 
-// --------- UTIL ---------
-const listRecentActiveOrders = async (limit = 10) => sheetsService.listRecentActiveOrders(limit);
-
 // --------- PENDING INPUT HANDLER ----------
 const handlePendingInput = async (message: TelegramMessage, adminUsername: string) => {
   const pending = pendingInputs.get(message.chat.id);
   if (!pending || !message.text) return false;
 
+  // Clear pending state immediately as the message has been consumed
+  // This is only for single-message inputs (NEW_ORDER_BUYER, CANCEL_REASON)
+  // RESTOCK_ACCOUNTS will re-set its state if it's not /selesai
+  if (pending.action !== 'RESTOCK_ACCOUNTS') {
+    pendingInputs.delete(message.chat.id);
+  }
+
   if (pending.action === 'NEW_ORDER_BUYER') {
     try {
       const buyer_id = message.text.trim();
@@ -224,19 +239,32 @@ const handlePendingInput = async (message: TelegramMessage, adminUsername: strin
   if (pending.action === 'CANCEL_REASON') {
     const orderId = pending.meta.order_id || '';
     const reason = message.text.trim() || 'Tidak disebutkan';
-    await orderService.cancelOrder(orderId, reason, adminUsername);
-    await telegramClient.sendMessage(message.chat.id, `Order ${orderId} dibatalkan.\nAlasan: ${reason}`);
+    try {
+      await orderService.cancelOrder(orderId, reason, adminUsername);
+      await telegramClient.sendMessage(message.chat.id, `Order ${orderId} dibatalkan.\nAlasan: ${reason}`);
+    } catch (err: any) {
+      console.error('Cancel order error', err);
+      await telegramClient.sendMessage(
+        message.chat.id,
+        `âŒ Pembatalan order gagal.\n${err?.message || 'Silakan coba lagi.'}`
+      );
+    }
   }
 
   if (pending.action === 'RESTOCK_ACCOUNTS') {
     const buffer = restockBuffers.get(message.chat.id);
     if (!buffer) return true;
     const text = message.text.trim();
+
     if (text.toLowerCase() === '/selesai' || text.toLowerCase() === 'selesai') {
+      // Clear pending state as input is finished, waiting for confirmation
+      pendingInputs.delete(message.chat.id);
+
       const uniqueInput = Array.from(new Set(buffer.lines));
       const existing = await sheetsService.listAccountIdentities(buffer.product.platform);
       const deduped = uniqueInput.filter((line) => !existing.has(line));
       const skipped = uniqueInput.length - deduped.length;
+
       await telegramClient.sendMessage(
         message.chat.id,
         `ðŸ“¥ Ringkasan Restok\n\nProduk: ${buffer.product.product_name || buffer.product.platform}\nTotal input: ${
@@ -258,6 +286,9 @@ const handlePendingInput = async (message: TelegramMessage, adminUsername: strin
       );
       restockBuffers.set(message.chat.id, { ...buffer, lines: deduped });
     } else {
+      // Re-set pending state for multi-message input
+      pendingInputs.set(message.chat.id, pending);
+
       const lines = text.split(/\n+/).map((l) => l.trim()).filter(Boolean);
       if (lines.length) {
         buffer.lines.push(...lines);
@@ -270,38 +301,69 @@ const handlePendingInput = async (message: TelegramMessage, adminUsername: strin
     }
   }
 
-  pendingInputs.delete(message.chat.id);
   return true;
 };
 
 // --------- CALLBACK HANDLER ----------
 const handleCallback = async (callback: CallbackQuery, adminUsername: string, isOwner: boolean) => {
   const chatId = callback.message?.chat.id;
-  if (!chatId || !callback.data) return;
+  const messageId = callback.message?.message_id;
+  if (!chatId || !callback.data || !messageId) {
+    await telegramClient.answerCallbackQuery(callback.id, 'Aksi tidak valid atau pesan tidak ditemukan.', true);
+    return;
+  }
+
+  // State Isolation Fix: Clear pending input state on any callback action
+  // This prevents message input from being processed as a stale pending action.
+  pendingInputs.delete(chatId);
+  // restockBuffers is kept until HOME or RESTOCK_CANCEL to allow multi-step restock
 
   const { action, payload } = decodeCallbackData(callback.data);
 
+  // Stale Button Check: Prevent re-triggering actions from old keyboards
+  const isStale = (action: string) => {
+    const staleActions = ['ORDER_CH', 'ORDER_PICK', 'ORDER_DURATION', 'PROBLEM_TYPE', 'EXP_PICK'];
+    return staleActions.includes(action);
+  };
+
+  if (isStale(action)) {
+    // Acknowledge the query to prevent Telegram from showing "Loading..." indefinitely
+    await telegramClient.answerCallbackQuery(callback.id, 'Aksi sudah kadaluarsa atau tidak valid.', true);
+    // Optionally, edit the message to remove the keyboard
+    await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
+    return;
+  }
+
   switch (action) {
     case 'HOME':
-      pendingInputs.clear();
-      restockBuffers.clear();
+      // State Isolation Fix: Use delete(chatId) instead of global clear()
+      pendingInputs.delete(chatId);
+      restockBuffers.delete(chatId);
       await sendHome(chatId, isOwner);
       break;
     case 'ORDER_NEW': {
+      // Stale Button Fix: Remove keyboard from the message that contained the 'ORDER_NEW' button
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       pendingInputs.set(chatId, { action: 'ORDER_CHANNEL', meta: {} });
       await sendOrderChannel(chatId);
       break;
     }
     case 'ORDER_CH': {
+      // Stale Button Fix: Remove keyboard from the message that contained the channel buttons
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       pendingInputs.set(chatId, { action: 'ORDER_CHANNEL', meta: { channel: payload.ch } });
       await sendProductSelection(chatId, 'ORDER_NEW', undefined, payload.ch);
       break;
     }
     case 'ORDER_PICK': {
+      // Stale Button Fix: Remove keyboard from the message that contained the product buttons
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       await sendDurationSelection(chatId, payload);
       break;
     }
     case 'ORDER_DURATION': {
+      // Stale Button Fix: Remove keyboard from the message that contained the duration buttons
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       const products = await gasClient.listActiveProducts();
       const product = products.find((p) => p.product_id === payload.pid);
       if (!product) {
@@ -323,23 +385,59 @@ const handleCallback = async (callback: CallbackQuery, adminUsername: string, is
       break;
     }
     case 'ORDER_SENT': {
-      await orderService.markOrderSent(payload.order_id, adminUsername);
-      await telegramClient.answerCallbackQuery(callback.id, 'Order ditandai terkirim');
+      // Idempotency Fix: Acknowledge immediately and rely on service layer for check
+      await telegramClient.answerCallbackQuery(callback.id, 'Memproses...');
+      try {
+        const result = await orderService.markOrderSent(payload.order_id, adminUsername);
+        if (result.already_sent) {
+          await telegramClient.answerCallbackQuery(callback.id, 'Order sudah ditandai terkirim', true);
+          break;
+        }
+        // Stale Button Fix: Remove keyboard after action is complete
+        await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
+        await telegramClient.answerCallbackQuery(callback.id, 'Order ditandai terkirim');
+      } catch (err: any) {
+        console.error('Order sent error', err);
+        await telegramClient.answerCallbackQuery(callback.id, 'Gagal menandai terkirim', true);
+        await telegramClient.sendMessage(
+          chatId,
+          `âŒ Gagal menandai order ${payload.order_id} terkirim.\n${err?.message || 'Silakan coba lagi.'}`
+        );
+      }
       break;
     }
     case 'ORDER_REPLACE': {
+      // Idempotency Fix: Acknowledge immediately and rely on service layer for check
+      await telegramClient.answerCallbackQuery(callback.id, 'Memproses penggantian akun...');
       if (!payload.seat_id) {
         await telegramClient.answerCallbackQuery(callback.id, 'Seat tidak diketahui', true);
         break;
       }
-      const seat = await seatService.replaceSeatWithReason(payload.seat_id, adminUsername, 'replace_request');
-      await telegramClient.sendMessage(
-        chatId,
-        `âœ… Akun pengganti siap\nSeat: ${seat.seat_id}\nAkun: ${seat.account_id}\nExpire: ${seat.end_date}`
-      );
+      try {
+        const seat = await seatService.replaceSeatWithReason(payload.seat_id, adminUsername, 'replace_request');
+        if (seat.already_replaced) {
+          await telegramClient.answerCallbackQuery(callback.id, 'Seat sudah diganti', true);
+          break;
+        }
+        // Stale Button Fix: Remove keyboard after action is complete
+        await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
+        await telegramClient.sendMessage(
+          chatId,
+          `âœ… Akun pengganti siap\nSeat: ${seat.seat_id}\nAkun: ${seat.account_id}\nExpire: ${seat.end_date}`
+        );
+      } catch (err: any) {
+        console.error('Order replace error', err);
+        await telegramClient.answerCallbackQuery(callback.id, 'Gagal mengganti akun', true);
+        await telegramClient.sendMessage(
+          chatId,
+          `âŒ Gagal mengganti akun untuk seat ${payload.seat_id}.\n${err?.message || 'Silakan coba lagi.'}`
+        );
+      }
       break;
     }
     case 'ORDER_CANCEL': {
+      // Stale Button Fix: Remove keyboard from the message that contained the cancel button
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       pendingInputs.set(chatId, { action: 'CANCEL_REASON', meta: { order_id: payload.order_id } });
       await telegramClient.sendMessage(chatId, 'Masukkan alasan cancel/refund:', { force_reply: true });
       break;
@@ -349,6 +447,8 @@ const handleCallback = async (callback: CallbackQuery, adminUsername: string, is
       break;
     }
     case 'PROBLEM': {
+      // Stale Button Fix: Remove keyboard from the message that contained the PROBLEM button
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       const keyboard: InlineKeyboardMarkup = {
         inline_keyboard: [
           [{ text: 'âŒ Akun tidak bisa dipakai', callback_data: encodeCallbackData('PROBLEM_TYPE', { t: 'problem' }) }],
@@ -361,6 +461,8 @@ const handleCallback = async (callback: CallbackQuery, adminUsername: string, is
       break;
     }
     case 'PROBLEM_TYPE': {
+      // Stale Button Fix: Remove keyboard from the message that contained the PROBLEM_TYPE buttons
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       const orders = await listRecentActiveOrders(10);
       if (!orders.length) {
         await telegramClient.sendMessage(chatId, 'Tidak ada order aktif.');
@@ -379,21 +481,40 @@ const handleCallback = async (callback: CallbackQuery, adminUsername: string, is
       break;
     }
     case 'PROBLEM_PICK': {
+      // Stale Button Fix: Remove keyboard from the message that contained the PROBLEM_PICK buttons
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       if (payload.t === 'cancel') {
         pendingInputs.set(chatId, { action: 'CANCEL_REASON', meta: { order_id: payload.order_id } });
         await telegramClient.sendMessage(chatId, 'Masukkan alasan cancel/refund:', { force_reply: true });
       } else if (payload.t === 'replace') {
-        const seat = await seatService.replaceSeatWithReason(payload.seat_id, adminUsername, 'problem_replace');
-        await telegramClient.sendMessage(
-          chatId,
-          `âœ… Akun pengganti siap\nSeat: ${seat.seat_id}\nAkun: ${seat.account_id}\nExpire: ${seat.end_date}`
-        );
+        // Idempotency Fix: Acknowledge immediately and rely on service layer for check
+        await telegramClient.answerCallbackQuery(callback.id, 'Memproses penggantian akun...');
+        try {
+          const seat = await seatService.replaceSeatWithReason(payload.seat_id, adminUsername, 'problem_replace');
+          if (seat.already_replaced) {
+            await telegramClient.answerCallbackQuery(callback.id, 'Seat sudah diganti', true);
+            break;
+          }
+          await telegramClient.sendMessage(
+            chatId,
+            `âœ… Akun pengganti siap\nSeat: ${seat.seat_id}\nAkun: ${seat.account_id}\nExpire: ${seat.end_date}`
+          );
+        } catch (err: any) {
+          console.error('Problem replace error', err);
+          await telegramClient.answerCallbackQuery(callback.id, 'Gagal mengganti akun', true);
+          await telegramClient.sendMessage(
+            chatId,
+            `âŒ Gagal mengganti akun untuk seat ${payload.seat_id}.\n${err?.message || 'Silakan coba lagi.'}`
+          );
+        }
       } else {
         await telegramClient.sendMessage(chatId, 'Catat masalah. Silakan ganti atau cancel sesuai kebutuhan.');
       }
       break;
     }
     case 'EXPIRING': {
+      // Stale Button Fix: Remove keyboard from the message that contained the EXPIRING button
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       const seats = await seatService.listExpiringToday();
       if (!seats.length) {
         await telegramClient.sendMessage(chatId, 'Tidak ada akun expired hari ini.');
@@ -412,6 +533,8 @@ const handleCallback = async (callback: CallbackQuery, adminUsername: string, is
       break;
     }
     case 'EXP_PICK': {
+      // Stale Button Fix: Remove keyboard from the message that contained the EXP_PICK buttons
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       const keyboard: InlineKeyboardMarkup = {
         inline_keyboard: [
           [{ text: 'âœ… Perpanjang', callback_data: encodeCallbackData('RENEW_CONFIRM', { seat_id: payload.seat_id }) }],
@@ -423,44 +546,92 @@ const handleCallback = async (callback: CallbackQuery, adminUsername: string, is
       break;
     }
     case 'RENEW_CONFIRM': {
-      await seatService.confirmRenew(payload.seat_id, adminUsername);
-      await telegramClient.answerCallbackQuery(callback.id, 'Diperpanjang');
+      // Idempotency Fix: Acknowledge immediately and rely on service layer for check
+      await telegramClient.answerCallbackQuery(callback.id, 'Memproses...');
+      try {
+        const result = await seatService.confirmRenew(payload.seat_id, adminUsername);
+        if (result.already_renewed) {
+          await telegramClient.answerCallbackQuery(callback.id, 'Sudah diperpanjang', true);
+          break;
+        }
+        // Stale Button Fix: Remove keyboard after action is complete
+        await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
+        await telegramClient.answerCallbackQuery(callback.id, 'Diperpanjang');
+      } catch (err: any) {
+        console.error('Renew confirm error', err);
+        await telegramClient.answerCallbackQuery(callback.id, 'Gagal perpanjang', true);
+        await telegramClient.sendMessage(
+          chatId,
+          `âŒ Gagal perpanjang seat ${payload.seat_id}.\n${err?.message || 'Silakan coba lagi.'}`
+        );
+      }
       break;
     }
     case 'RENEW_SKIP': {
-      await seatService.skipRenew(payload.seat_id, adminUsername);
-      await telegramClient.answerCallbackQuery(callback.id, 'Ditandai tidak perpanjang');
+      // Idempotency Fix: Acknowledge immediately and rely on service layer for check
+      await telegramClient.answerCallbackQuery(callback.id, 'Memproses...');
+      try {
+        const result = await seatService.skipRenew(payload.seat_id, adminUsername);
+        if (result.already_skipped) {
+          await telegramClient.answerCallbackQuery(callback.id, 'Sudah ditandai tidak perpanjang', true);
+          break;
+        }
+        // Stale Button Fix: Remove keyboard after action is complete
+        await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
+        await telegramClient.answerCallbackQuery(callback.id, 'Ditandai tidak perpanjang');
+      } catch (err: any) {
+        console.error('Renew skip error', err);
+        await telegramClient.answerCallbackQuery(callback.id, 'Gagal skip perpanjangan', true);
+        await telegramClient.sendMessage(
+          chatId,
+          `âŒ Gagal skip perpanjangan seat ${payload.seat_id}.\n${err?.message || 'Silakan coba lagi.'}`
+        );
+      }
       break;
     }
     case 'REPORT': {
+      // Stale Button Fix: Remove keyboard from the message that contained the REPORT button
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       await sendReportMenu(chatId);
       break;
     }
     case 'REPORT_STOCK': {
+      // Idempotency Fix: Acknowledge immediately
+      await telegramClient.answerCallbackQuery(callback.id, 'Mengambil laporan stok...');
       try {
         const report = await reportService.stockSummary();
         await telegramClient.sendMessage(chatId, `ðŸ“¦ Stok & Slot\n${report.text}`);
-      } catch (err) {
-        await telegramClient.sendMessage(chatId, 'Gagal ambil laporan stok');
+      } catch (err: any) {
+        console.error('Report stock error', err);
+        await telegramClient.answerCallbackQuery(callback.id, 'Gagal ambil laporan stok', true);
+        await telegramClient.sendMessage(chatId, `âŒ Gagal ambil laporan stok.\n${err?.message || 'Silakan coba lagi.'}`);
       }
       break;
     }
     case 'REPORT_DAY':
     case 'REPORT_WEEK':
     case 'REPORT_MONTH': {
+      // Idempotency Fix: Acknowledge immediately
+      await telegramClient.answerCallbackQuery(callback.id, 'Mengambil laporan...');
       try {
         const report = await reportService.salesSummary();
         await telegramClient.sendMessage(chatId, `ðŸ“Š Report\n${report.text}`);
-      } catch (err) {
-        await telegramClient.sendMessage(chatId, 'Gagal ambil laporan');
+      } catch (err: any) {
+        console.error('Report sales error', err);
+        await telegramClient.answerCallbackQuery(callback.id, 'Gagal ambil laporan', true);
+        await telegramClient.sendMessage(chatId, `âŒ Gagal ambil laporan.\n${err?.message || 'Silakan coba lagi.'}`);
       }
       break;
     }
     case 'RESTOCK': {
+      // Stale Button Fix: Remove keyboard from the message that contained the RESTOCK button
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       await startRestock(chatId);
       break;
     }
     case 'RESTOCK_PICK': {
+      // Stale Button Fix: Remove keyboard from the message that contained the RESTOCK_PICK buttons
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       const products = await gasClient.listActiveProducts();
       const product = products.find((p) => p.product_id === payload.product_id);
       if (!product) {
@@ -473,27 +644,70 @@ const handleCallback = async (callback: CallbackQuery, adminUsername: string, is
       break;
     }
     case 'RESTOCK_CONFIRM': {
+      // Idempotency Fix: Acknowledge immediately
+      await telegramClient.answerCallbackQuery(callback.id, 'Memproses konfirmasi restok...');
       const buffer = restockBuffers.get(chatId);
       if (!buffer) {
         await telegramClient.answerCallbackQuery(callback.id, 'Tidak ada data restok', true);
         break;
       }
-      const accounts = buffer.lines.map((line) => ({
+
+      // Race-Safe Restock Fix: Re-run deduplication check before final write
+      const uniqueInput = buffer.lines; // Already deduped against initial check
+      const existing = await sheetsService.listAccountIdentities(buffer.product.platform);
+      const finalDeduped = uniqueInput.filter((line) => !existing.has(line));
+      const newlySkipped = uniqueInput.length - finalDeduped.length;
+
+      if (newlySkipped > 0) {
+        await telegramClient.sendMessage(
+          chatId,
+          `âš ï¸ ${newlySkipped} akun baru saja ditambahkan oleh admin lain dan dilewati.`
+        );
+      }
+
+      const accounts = finalDeduped.map((line) => ({
         platform: buffer.product.platform,
         mode: buffer.product.mode,
         email: line,
         max_slot: 1,
       }));
-      const result = await gasClient.restockAccounts({ accounts, actor: adminUsername });
-      await telegramClient.sendMessage(
-        chatId,
-        `âœ… Stok berhasil ditambahkan\nAkun dibuat: ${result.accounts.map((a) => a.account_id).join(', ')}`
-      );
+
+      if (accounts.length === 0) {
+        await telegramClient.sendMessage(chatId, 'Tidak ada akun baru untuk ditambahkan.');
+        restockBuffers.delete(chatId);
+        pendingInputs.delete(chatId);
+        // Stale Button Fix: Remove keyboard after action is complete
+        await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
+        break;
+      }
+
+      try {
+        const result = await gasClient.restockAccounts({ accounts, actor: adminUsername });
+        // Simulate adding the new accounts to the existing set for the next dedupe check (Race-Safe)
+        finalDeduped.forEach(sheetsService.addAccountIdentity);
+
+        await telegramClient.sendMessage(
+          chatId,
+          `âœ… Stok berhasil ditambahkan\nAkun dibuat: ${result.accounts.map((a: AccountResult) => a.account_id).join(', ')}`
+        );
+        // Stale Button Fix: Remove keyboard after action is complete
+        await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
+      } catch (err: any) {
+        console.error('Restock confirm error', err);
+        await telegramClient.answerCallbackQuery(callback.id, 'Gagal konfirmasi restok', true);
+        await telegramClient.sendMessage(
+          chatId,
+          `âŒ Gagal konfirmasi restok.\n${err?.message || 'Silakan coba lagi.'}`
+        );
+      }
+
       restockBuffers.delete(chatId);
       pendingInputs.delete(chatId);
       break;
     }
     case 'RESTOCK_CANCEL': {
+      // Stale Button Fix: Remove keyboard after action is complete
+      await editMessageReplyMarkup(chatId, messageId, { inline_keyboard: [] });
       restockBuffers.delete(chatId);
       pendingInputs.delete(chatId);
       await telegramClient.sendMessage(chatId, 'Restok dibatalkan.');
@@ -513,12 +727,14 @@ export const telegramController = {
     const from = update.message?.from ?? update.callback_query?.from;
     if (!from) return { status: 'ignored' };
 
+    const chatId = update.message?.chat.id ?? update.callback_query?.message?.chat.id;
+
     try {
       const tag = update.callback_query
         ? `callback:${update.callback_query.data ?? ''}`
         : `message:${(update.message?.text ?? '').slice(0, 50)}`;
       console.log(
-        `[TG] from=@${from.username ?? from.id} chat=${update.message?.chat.id ?? update.callback_query?.message?.chat.id ?? 'n/a'} ${tag}`
+        `[TG] from=@${from.username ?? from.id} chat=${chatId ?? 'n/a'} ${tag}`
       );
     } catch {
       /* ignore */
@@ -529,9 +745,13 @@ export const telegramController = {
       admin = await adminService.ensureActive(from.username);
     } catch (error) {
       if (update.callback_query) {
+        // Error UX Fix: Use persistent message for unauthorized access
         await telegramClient.answerCallbackQuery(update.callback_query.id, 'Tidak punya akses', true);
+        if (chatId) {
+          await telegramClient.sendMessage(chatId, 'âŒ Akses ditolak. Hubungi owner.');
+        }
       } else if (update.message) {
-        await telegramClient.sendMessage(update.message.chat.id, 'Akses ditolak. Hubungi owner.');
+        await telegramClient.sendMessage(update.message.chat.id, 'âŒ Akses ditolak. Hubungi owner.');
       }
       return { status: 'unauthorized' };
     }
@@ -539,13 +759,20 @@ export const telegramController = {
     if (update.callback_query) {
       try {
         await handleCallback(update.callback_query, admin.telegram_username, adminService.isOwner(admin));
-      } catch (err) {
+      } catch (err: any) {
         console.error('TG callback error:', err);
+        // Error UX Fix: Send persistent error message to chat
         await telegramClient.answerCallbackQuery(
           update.callback_query.id,
           'Terjadi error, coba lagi atau cek log.',
           true
         );
+        if (chatId) {
+          await telegramClient.sendMessage(
+            chatId,
+            `âŒ Terjadi error saat memproses aksi. Silakan coba lagi.\nDetail: ${err?.message || 'Unknown error'}`
+          );
+        }
       }
       return { status: 'ok' };
     }
diff --git a/src/services/sheets.service.ts.original b/src/services/sheets.service.ts
index db8deb7..c330552 100644
--- a/src/services/sheets.service.ts.original
+++ b/src/services/sheets.service.ts
@@ -1,4 +1,20 @@
+import { FAKE_MODE } from '../config';
+
+const existingAccounts = new Set(['existing_acc@test.com']);
+
 export const sheetsService = {
     listRecentActiveOrders: async (limit: number) => ([{ order_id: 'O1', seat_id: 'S1', product_id: 'P1', buyer_id: 'buyer1' }]),
-    listAccountIdentities: async (platform: string) => (new Set(['existing_acc@test.com'])),
+    listAccountIdentities: async (platform: string) => {
+        if (FAKE_MODE) {
+            // Simulate race condition by adding the account from Admin A's confirm to the existing set
+            if (platform === 'Platform A' && existingAccounts.has('acc_race@test.com')) {
+                return new Set([...existingAccounts, 'acc_race@test.com']);
+            }
+        }
+        return existingAccounts;
+    },
+    // Mock function to simulate the write operation adding the account
+    addAccountIdentity: (account: string) => {
+        existingAccounts.add(account);
+    }
 };
